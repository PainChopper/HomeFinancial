# HomeFinancial

## О проекте

HomeFinancial изначально задумывался как простая "домашняя бухгалтерия" для личного использования, но впоследствии был переработан с целью демонстрации технических навыков и подходов к разработке высоконагруженных приложений. Несмотря на то, что для домашней бухгалтерии такие оптимизации избыточны, проект стал отличной площадкой для применения передовых практик разработки.

Основная задача приложения — потоковый импорт и эффективный анализ банковских выписок в формате OFX, реализованный с учетом обработки больших объемов данных без существенной нагрузки на ресурсы системы.

## Ключевые особенности

- **Потоковая асинхронная обработка данных** — приложение работает с файлами любого размера, не загружая их целиком в память
- **Оптимизированная работа с XML** — использует потоковое чтение через `XmlReader` вместо DOM-модели
- **Конкурентно-безопасные операции** — атомарные вставки с использованием `INSERT ON CONFLICT`
- **Высокопроизводительная вставка данных** — пакетная вставка через PostgreSQL COPY вместо отдельных INSERT
- **Система блокировок на Redis** — предотвращение одновременной обработки одного файла разными процессами
- **Полностью асинхронный код** — эффективное использование ресурсов сервера при большом количестве запросов

## Технический стек

- **Язык программирования:** C# 12 / .NET 8
- **Архитектура:** Слоистая архитектура с разделением на Domain, Application, Infrastructure и WebApi
- **Паттерны проектирования:** Repository, CQRS, async/await
- **База данных:** PostgreSQL с использованием Entity Framework Core
- **Управление блокировками:** Redis с использованием Lua-скриптов для атомарных операций
- **API:** ASP.NET Core Web API с контроллерами
- **Тестирование:** xUnit, FluentAssertions
- **Производительность:**
  - Ленивая потоковая обработка данных через `IAsyncEnumerable<T>`
  - Атомарные операции в базе данных для конкурентной работы
  - Оптимизированный SQL для массовых операций (COPY)
  - Эффективная потоковая работа с XML без создания промежуточных объектов

## Оптимизации для высокой нагрузки

- **Память:** потоковая обработка XML вместо загрузки в DOM модель, что критично при работе с большими файлами
- **Процессор:** асинхронные операции ввода-вывода для эффективного использования потоков
- **База данных:** 
  - Пакетная вставка через PostgreSQL COPY (в 10-100 раз быстрее одиночных INSERT)
  - Оптимизированные атомарные операции через INSERT ON CONFLICT
- **Concurrency:** 
  - Система блокировок на Redis с использованием распределенных блокировок (Lease)
  - Lua-скрипты для атомарных операций с блокировками
  - Потокобезопасная обработка одинаковых запросов от разных пользователей

## Особенности реализации

- **Эффективная парсинг-модель:** XML обрабатывается единым проходом через поток, без полной загрузки в память
- **Асинхронное API:** все операции поддерживают асинхронность, включая отмену операций через CancellationToken
- **Распределенная блокировка файлов:** использование Redis для предотвращения одновременной обработки одного файла разными процессами
- **Оптимизированная БД:** механизм блокировок и атомарных операций для обеспечения надежности данных
- **Устойчивость к сбоям:** обработка исключений и откат транзакций с логированием ошибок

## Запуск проекта

Для запуска проекта требуется:
- .NET 8 SDK
- Docker и Docker Compose (для локальной разработки)

### Запуск с Docker

Проект содержит готовую конфигурацию Docker для быстрого развертывания инфраструктуры:

```bash
# Клонирование репозитория
git clone https://github.com/your-username/HomeFinancial.git
cd HomeFinancial

# Запуск инфраструктуры (PostgreSQL и Redis)
cd docker-infra
docker-compose up -d

# Сборка и запуск приложения
cd ..
dotnet restore
dotnet build
dotnet run --project HomeFinancial.WebApi
```

Docker-контейнеры включают:
- PostgreSQL (порт 5432)
- Redis (порт 6379)

## Лицензия

MIT License
